# Thermostat Sensors Package
# Template sensors for temperature/humidity averaging and status monitoring
thermostat_stensors:
  template:
    - sensor:
        # -----------------------------------------------------------------------
        # Temperature Averaging
        # -----------------------------------------------------------------------
        - name: "Thermostat Average Temperature"
          unique_id: "a3f2d8c4-1e5b-4a2f-9c3e-7d8f1a2b3c4d"
          state_class: measurement
          device_class: temperature
          unit_of_measurement: "°C"
          state: >
            {# Map sensors to their enable/disable toggles #}
            {% set sensor_map = {
              'sensor.livingroom_zigbee_temperature_temperature': 'input_boolean.thermostat_use_living_room_temp',
              'sensor.bedroom_zigbee_tempurature_temperature': 'input_boolean.thermostat_use_bedroom_temp',
              'sensor.kitchen_zigbee_temperature_temperature': 'input_boolean.thermostat_use_kitchen_temp',
              'sensor.office_zigbee_temperature_temperature': 'input_boolean.thermostat_use_office_temp'
            } %}

            {# Use a namespace to allow 'temps' to persist outside the loop #}
            {% set ns = namespace(temps=[]) %}

            {% for sensor, toggle in sensor_map.items() %}
              {% if is_state(toggle, 'on') and states(sensor) | is_number %}
                {% set ns.temps = ns.temps + [states(sensor) | float] %}
              {% endif %}
            {% endfor %}

            {% if ns.temps | length > 0 %}
              {# Calculate average #}
              {% set avg_f = (ns.temps | sum / ns.temps | length) %}
              {# Convert Fahrenheit to Celsius: (°F - 32) × 5/9 #}
              {{ ((avg_f - 32) * 5 / 9) | round(1) }}
            {% else %}
              {# Fallback to local sensor #}
              {{ states('sensor.smart_thermostat_local_temperature') | float(21) }}
            {% endif %}
        # -----------------------------------------------------------------------
        # Humidity Averaging
        # -----------------------------------------------------------------------
        - name: "Thermostat Average Humidity"
          unique_id: "b4e3c9d5-2f6c-4b3g-8d4f-1e9g2b3c4d5e"
          state_class: measurement
          device_class: humidity
          unit_of_measurement: "%"
          state: >
            {# Map humidity sensors to the same toggles used for temperature #}
            {% set sensor_map = {
              'sensor.livingroom_zigbee_temperature_humidity': 'input_boolean.thermostat_use_living_room_temp',
              'sensor.bedroom_zigbee_tempurature_humidity': 'input_boolean.thermostat_use_bedroom_temp',
              'sensor.kitchen_zigbee_temperature_humidity': 'input_boolean.thermostat_use_kitchen_temp',
              'sensor.office_zigbee_temperature_humidity': 'input_boolean.thermostat_use_office_temp'
            } %}

            {% set ns = namespace(humids=[]) %}

            {% for sensor, toggle in sensor_map.items() %}
              {# Check if the room's toggle is ON and the sensor has a valid number #}
              {% if is_state(toggle, 'on') and states(sensor) | is_number %}
                {% set ns.humids = ns.humids + [states(sensor) | float] %}
              {% endif %}
            {% endfor %}

            {% if ns.humids | length > 0 %}
              {{ (ns.humids | sum / ns.humids | length) | round(0) }}
            {% else %}
              {# Fallback to local sensor if no room toggles are on or sensors are offline #}
              {{ states('sensor.smart_thermostat_local_humidity') | float(50) }}
            {% endif %}
        # -----------------------------------------------------------------------
        # Humidifier Auto Setpoint (outdoor temperature based)
        # -----------------------------------------------------------------------
        - name: "Humidifier Auto Setpoint"
          unique_id: "c5d4e0f6-3g7d-4c4h-9e5g-2f0h3c4d5e6f"
          unit_of_measurement: "%"
          icon: "mdi:water-percent"
          state: >
            {% set outdoor_temp = states('sensor.smart_thermostat_outdoor_temperature') | float(0) %}

            {# 
              Linear logic: At 20°F (-6°C), we want ~35%. At 0°F (-18°C), we want ~25%.
              Formula: (Outdoor Temp + 20) / 2 + 25 (simplified example)
              Or use a more precise Building Science slope:
            #}

            {% if outdoor_temp >= 10 %}
              {% set target = 45 %}
            {% elif outdoor_temp <= -20 %}
              {% set target = 20 %}
            {% else %}
              {# This creates a smooth line between 20% at -20°C and 45% at 10°C #}
              {% set target = ((outdoor_temp - (-20)) * (45 - 20) / (10 - (-20)) + 20) | round(0) %}
            {% endif %}

            {# Safety: Never exceed 45% and never drop below a healthy 20% #}
            {{ [ [target, 45] | min, 20 ] | max }}

        # -----------------------------------------------------------------------
        # Humidifier Effective Setpoint (auto or manual)
        # -----------------------------------------------------------------------
        - name: "Humidifier Effective Setpoint"
          unique_id: "d6e5f1g7-4h8e-5d5i-0f6h-3g1i4d5e6f7g"
          unit_of_measurement: "%"
          icon: "mdi:water-percent"
          state: >
            {% if is_state('input_boolean.humidifier_manual_setpoint', 'on') %}
              {{ states('input_number.humidifier_manual_setpoint') | float }}
            {% else %}
              {{ states('sensor.humidifier_auto_setpoint') | float }}
            {% endif %}

        # -----------------------------------------------------------------------
        # Ecobee Passthrough Status
        # -----------------------------------------------------------------------
        - name: "Thermostat Ecobee Passthrough Status"
          unique_id: "e7f6g2h8-5i9f-6e6j-1g7i-4h2j5e6f7g8h"
          state: >
            {% if is_state('switch.smart_thermostat_ecobee_passthrough_mode', 'on') %}
              Active - Ecobee Controlling
            {% else %}
              Inactive - Smart Thermostat Controlling
            {% endif %}
          icon: >
            {% if is_state('switch.smart_thermostat_ecobee_passthrough_mode', 'on') %}
              mdi:transit-connection-variant
            {% else %}
              mdi:chip
            {% endif %}

        # -----------------------------------------------------------------------
        # System Mismatch Status
        # -----------------------------------------------------------------------
        - name: "Thermostat System Mismatch Status"
          unique_id: "f8g7h3i9-6j0g-7f7k-2h8j-5i3k6f7g8h9i"
          state: >
            {% set ecobee_w1 = is_state('binary_sensor.smart_thermostat_ecobee_heat_stage_1_input', 'on') %}
            {% set ecobee_w2 = is_state('binary_sensor.smart_thermostat_ecobee_heat_stage_2_input', 'on') %}
            {% set ecobee_y1 = is_state('binary_sensor.smart_thermostat_ecobee_cooling_input', 'on') %}
            {% set our_heating = is_state('binary_sensor.smart_thermostat_heating_active', 'on') %}
            {% set our_cooling = is_state('binary_sensor.smart_thermostat_cooling_active', 'on') %}
            {% set our_stage2 = is_state('binary_sensor.smart_thermostat_stage_2_active', 'on') %}
            {% set passthrough = is_state('switch.smart_thermostat_ecobee_passthrough_mode', 'on') %}

            {% if passthrough %}
              Passthrough Mode - No Comparison
            {% else %}
              {% set mismatches = [] %}
              {% if ecobee_w1 and not our_heating %}
                {% set mismatches = mismatches + ['Ecobee calling for heat, we are not'] %}
              {% endif %}
              {% if ecobee_w2 and not our_stage2 %}
                {% set mismatches = mismatches + ['Ecobee calling for stage 2, we are not'] %}
              {% endif %}
              {% if ecobee_y1 and not our_cooling %}
                {% set mismatches = mismatches + ['Ecobee calling for cooling, we are not'] %}
              {% endif %}
              {% if our_heating and not ecobee_w1 %}
                {% set mismatches = mismatches + ['We are calling for heat, ecobee is not'] %}
              {% endif %}
              {% if our_cooling and not ecobee_y1 %}
                {% set mismatches = mismatches + ['We are calling for cooling, ecobee is not'] %}
              {% endif %}

              {% if mismatches | length > 0 %}
                MISMATCH: {{ mismatches | join('; ') }}
              {% else %}
                Systems Synchronized
              {% endif %}
            {% endif %}
          icon: >
            {% set passthrough = is_state('switch.smart_thermostat_ecobee_passthrough_mode', 'on') %}
            {% if passthrough %}
              mdi:check-circle-outline
            {% elif 'MISMATCH' in states('sensor.thermostat_system_mismatch_status') %}
              mdi:alert-circle
            {% else %}
              mdi:check-circle
            {% endif %}

        # -----------------------------------------------------------------------
        # Heating Cycles Last Hour (for excessive cycling detection)
        # -----------------------------------------------------------------------
        - name: "Thermostat Heating Cycles Last Hour"
          unique_id: "g9h8i4j0-7k1h-8g8l-3i9k-6j4l7g8h9i0j"
          state: "{{ states('counter.thermostat_heating_cycles_today') | int }}"
          unit_of_measurement: "cycles"
          icon: "mdi:fire"

        # -----------------------------------------------------------------------
        # Stage 2 Control - Time Since Setpoint Change
        # -----------------------------------------------------------------------
        - name: "Time Since Setpoint Change"
          unique_id: "s1t0u6v2-0w4t-1s1x-6u2w-0v7x1s0t1u2v"
          unit_of_measurement: "min"
          icon: "mdi:clock-outline"
          state: >
            {% if states.climate.smart_thermostat.attributes.temperature is defined %}
              {{ ((now() - states.climate.smart_thermostat.last_changed).total_seconds() / 60) | round(1) }}
            {% else %}
              999
            {% endif %}

        # -----------------------------------------------------------------------
        # Stage 2 Control - Time Since Preset Change
        # -----------------------------------------------------------------------
        - name: "Time Since Preset Change"
          unique_id: "t2u1v7w3-1x5u-2t2y-7v3x-1w8y2t1u2v3w"
          unit_of_measurement: "min"
          icon: "mdi:clock-outline"
          state: >
            {% set preset_attr = state_attr('climate.smart_thermostat', 'preset_mode') %}
            {% if preset_attr is not none %}
              {{ ((now() - states.climate.smart_thermostat.last_changed_preset_mode | default(now())).total_seconds() / 60) | round(1) }}
            {% else %}
              999
            {% endif %}

        # -----------------------------------------------------------------------
        # Stage 2 Control - Current Temperature Delta
        # -----------------------------------------------------------------------
        - name: "Current Temperature Delta"
          unique_id: "u3v2w8x4-2y6v-3u3z-8w4y-2x9z3u2v3w4x"
          unit_of_measurement: "°F"
          icon: "mdi:thermometer-lines"
          device_class: temperature
          state: >
            {% set current_temp = states('sensor.smart_thermostat_effective_temperature') | float(70) %}
            {% set setpoint = state_attr('climate.smart_thermostat', 'temperature') | float(70) %}
            {{ (setpoint - current_temp) | round(1) }}

        # -----------------------------------------------------------------------
        # Stage 2 Active Urgency Factor (preset-specific multiplier)
        # -----------------------------------------------------------------------
        - name: "Stage 2 Active Urgency Factor"
          unique_id: "y7z6a2b8-6c0z-7y7d-2a8c-6b3d7y6z7a8b"
          icon: "mdi:speedometer"
          state: >
            {% set preset = states('sensor.active_preset_mode') | lower %}
            {% if preset == 'home' %}
              {{ states('input_number.stage2_urgency_home') | float(1.0) }}
            {% elif preset == 'away' %}
              {{ states('input_number.stage2_urgency_away') | float(1.5) }}
            {% elif preset == 'sleep' %}
              {{ states('input_number.stage2_urgency_sleep') | float(1.2) }}
            {% elif preset == 'boost' %}
              {{ states('input_number.stage2_urgency_boost') | float(0.5) }}
            {% else %}
              1.0
            {% endif %}

        # -----------------------------------------------------------------------
        # DIAGNOSTIC: Losing Ground During Heating
        # Detects when heating is active but temp is still dropping or flat
        # -----------------------------------------------------------------------
        - name: "Heating Cycle Progress"
          unique_id: "b0c9d5e1-9f3c-0b0g-5d1f-9e6g0b9c0d1e"
          unit_of_measurement: "°F"
          icon: "mdi:thermometer-chevron-up"
          device_class: temperature
          state: >
            {% if is_state('binary_sensor.smart_thermostat_heating_active', 'on') %}
              {% set cycle_data = states('input_text.thermostat_recent_cycles') | from_json %}
              {% set start_temp = cycle_data.start_temp | float(70) %}
              {% set current_temp = states('sensor.smart_thermostat_effective_temperature') | float(70) %}
              {% set progress = current_temp - start_temp %}
              {{ progress | round(2) }}
            {% else %}
              0
            {% endif %}

    - binary_sensor:
        # -----------------------------------------------------------------------
        # System Mismatch Detected (for automation triggering)
        # -----------------------------------------------------------------------
        - name: "Thermostat System Mismatch Detected"
          unique_id: "h0i9j5k1-8l2i-9h9m-4j0l-7k5m8h9i0j1k"
          state: "{{ 'MISMATCH' in states('sensor.thermostat_system_mismatch_status') }}"
          device_class: problem

        # -----------------------------------------------------------------------
        # Everyone Away (occupancy sensor)
        # CUSTOMIZE: Replace with your actual person entities
        # -----------------------------------------------------------------------
        - name: "Everyone Away"
          unique_id: "i1j0k6l2-9m3j-0i0n-5k1m-8l6n9i0j1k2l"
          state: >
            {# CUSTOMIZE: Update these person entity IDs #}
            {{ is_state('person.eric_bartos', 'not_home') and
              is_state('person.seama', 'not_home') }}
          device_class: occupancy

        # -----------------------------------------------------------------------
        # Stage 2 Near-Setpoint Inhibit (within 1.5°F of target)
        # -----------------------------------------------------------------------
        - name: "Stage 2 Near-Setpoint Inhibit"
          unique_id: "v4w3x9y5-3z7w-4v4a-9x5z-3y0a4v3w4x5y"
          icon: "mdi:thermometer-check"
          state: >
            {% set delta = states('sensor.current_temperature_delta') | float(5) %}
            {{ delta <= 1.5 and delta > 0 }}

        # -----------------------------------------------------------------------
        # Stage 2 Large Delta Trigger (>3°F change in last 5 minutes)
        # -----------------------------------------------------------------------
        - name: "Stage 2 Large Delta Trigger"
          unique_id: "w5x4y0z6-4a8x-5w5b-0y6a-4z1b5w4x5y6z"
          icon: "mdi:thermometer-alert"
          state: >
            {% set delta = states('sensor.current_temperature_delta') | float(0) %}
            {% set time_since_setpoint = states('sensor.time_since_setpoint_change') | float(999) %}
            {% set time_since_preset = states('sensor.time_since_preset_change') | float(999) %}
            {% set recent_change = time_since_setpoint <= 5 or time_since_preset <= 5 %}
            {{ delta > 3.0 and recent_change }}

        # -----------------------------------------------------------------------
        # Stage 2 Should Engage (combines all logic)
        # -----------------------------------------------------------------------
        - name: "Stage 2 Should Engage"
          unique_id: "x6y5z1a7-5b9y-6x6c-1z7b-5a2c6x5y6z7a"
          icon: "mdi:numeric-2-box"
          state: >
            {% set disabled = is_state('input_boolean.stage2_temporarily_disabled', 'on') %}
            {% set inhibit = is_state('binary_sensor.stage2_near_setpoint_inhibit', 'on') %}
            {% set large_delta = is_state('binary_sensor.stage2_large_delta_trigger', 'on') %}
            {% set heating = is_state('binary_sensor.smart_thermostat_heating_active', 'on') %}

            {# Don't engage if disabled or near setpoint (unless large delta override) #}
            {% if disabled %}
              {{ false }}
            {% elif inhibit and not large_delta %}
              {{ false }}
            {% elif heating %}
              {{ true }}
            {% else %}
              {{ false }}
            {% endif %}

        # -----------------------------------------------------------------------
        # DIAGNOSTIC: Losing Ground During Heating
        # TRUE when heating has been on 5+ min but temp is still dropping
        # -----------------------------------------------------------------------
        - name: "Losing Ground While Heating"
          unique_id: "d2e1f7g3-1h5e-2d2i-8f3h-2g8i3d2e3f4g"
          icon: "mdi:alert-circle-outline"
          device_class: problem
          state: >
            {% set heating = is_state('binary_sensor.smart_thermostat_heating_active', 'on') %}
            {% set heating_duration = (now() - states.binary_sensor.smart_thermostat_heating_active.last_changed).total_seconds() / 60 %}
            {% set progress = states('sensor.heating_cycle_progress') | float(0) %}
            {% set rate_5min = states('sensor.temperature_change_rate_5min') | float(0) %}

            {# Heating is active for 5+ min but temp dropping or flat #}
            {{ heating and heating_duration > 5 and (progress <= 0 or rate_5min < -0.02) }}
  # History stats sensors for runtime tracking
  sensor:
    - platform: history_stats
      name: "Heating Runtime Today"
      unique_id: "j2k1l7m3-0n4k-1j1o-6l2n-9m7o0j1k2l3m"
      entity_id: binary_sensor.smart_thermostat_heating_active
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Cooling Runtime Today"
      unique_id: "k3l2m8n4-1o5l-2k2p-7m3o-0n8p1k2l3m4n"
      entity_id: binary_sensor.smart_thermostat_cooling_active
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Humidifier Runtime Today"
      unique_id: "l4m3n9o5-2p6m-3l3q-8n4p-1o9q2l3m4n5o"
      entity_id: switch.smart_thermostat_humidifier_relay
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Smart Thermostat Control Time Today"
      unique_id: "m5n4o0p6-3q7n-4m4r-9o5q-2p0r3m4n5o6p"
      entity_id: switch.smart_thermostat_ecobee_passthrough_mode
      state: "off"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Ecobee Control Time Today"
      unique_id: "n6o5p1q7-4r8o-5n5s-0p6r-3q1s4n5o6p7q"
      entity_id: switch.smart_thermostat_ecobee_passthrough_mode
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) }}"
      end: "{{ now() }}"

    # -------------------------------------------------------------------------
    # AI Learning Sensors - Weekly Performance Tracking
    # -------------------------------------------------------------------------
    - platform: history_stats
      name: "Heating Runtime This Week"
      unique_id: "o7p6q2r8-5s9p-6o6t-1q7s-4r2t5o6p7q8r"
      entity_id: binary_sensor.smart_thermostat_heating_active
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) - timedelta(days=now().weekday()) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Heating Cycles This Week"
      unique_id: "p8q7r3s9-6t0q-7p7u-2r8t-5s3u6p7q8r9s"
      entity_id: binary_sensor.smart_thermostat_heating_active
      state: "on"
      type: count
      start: "{{ now().replace(hour=0, minute=0, second=0) - timedelta(days=now().weekday()) }}"
      end: "{{ now() }}"

    - platform: history_stats
      name: "Stage 2 Runtime This Week"
      unique_id: "q9r8s4t0-7u1r-8q8v-3s9u-6t4v7q8r9s0t"
      entity_id: binary_sensor.smart_thermostat_stage_2_active
      state: "on"
      type: time
      start: "{{ now().replace(hour=0, minute=0, second=0) - timedelta(days=now().weekday()) }}"
      end: "{{ now() }}"

    - platform: statistics
      name: "Outdoor Temperature Avg Week"
      unique_id: "r0s9t5u1-8v2s-9r9w-4t0v-7u5w8r9s0t1u"
      entity_id: sensor.smart_thermostat_outdoor_temperature
      state_characteristic: mean
      sampling_size: 1000
      max_age:
        days: 7

    # =========================================================================
    # DIAGNOSTIC SENSORS: Rate of Change Monitoring
    # These sensors collect data to determine if ROC-based stage 2 logic is needed
    # =========================================================================

    # Temperature derivative - 5 minute window
    - platform: derivative
      name: "Temperature Change Rate (5min)"
      source: sensor.smart_thermostat_effective_temperature
      time_window: "00:05:00"
      unit_time: min
      unit: "°F"
      round: 4

    # Temperature derivative - 10 minute window (smoother)
    - platform: derivative
      name: "Temperature Change Rate (10min)"
      source: sensor.smart_thermostat_effective_temperature
      time_window: "00:10:00"
      unit_time: min
      unit: "°F"
      round: 4

    # Statistics on temperature change during heating (min/max/mean)
    - platform: statistics
      name: "Temperature Change Stats During Heating"
      unique_id: "c1d0e6f2-0g4d-1c1h-6e2g-0f7h1c0d1e2f"
      entity_id: sensor.temperature_change_rate_5min
      state_characteristic: mean
      sampling_size: 50
      max_age:
        hours: 1
