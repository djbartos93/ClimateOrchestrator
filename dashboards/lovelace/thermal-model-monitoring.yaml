# Thermal Model & Stage 2 Control Monitoring Dashboard
# This dashboard shows all aspects of the thermal model learning system
# and stage 2 intelligent control features

title: Thermal Model Monitor
icon: mdi:chart-line
path: thermal-model
type: sections
max_columns: 3
sections:

  # ========================================================================
  # SECTION 1: Current Heating Status & Progress
  # ========================================================================
  - type: grid
    title: Current Heating Cycle
    cards:
      - type: entities
        title: Heating Status
        entities:
          - entity: binary_sensor.smart_thermostat_heating_active
            name: Heating Active
          - entity: binary_sensor.smart_thermostat_stage_2_active
            name: Stage 2 Active
          - entity: sensor.current_temperature_delta
            name: Temperature to Go
          - entity: sensor.heating_cycle_progress
            name: Temperature Gain This Cycle
          - entity: binary_sensor.losing_ground_while_heating
            name: âš ï¸ Losing Ground Alert

      - type: gauge
        entity: sensor.current_temperature_delta
        name: Distance from Setpoint
        min: 0
        max: 10
        needle: true
        severity:
          green: 0
          yellow: 1.5
          red: 3

      - type: sensor
        entity: sensor.smart_thermostat_effective_temperature
        graph: line
        detail: 2
        hours_to_show: 4
        name: Temperature Trend

  # ========================================================================
  # SECTION 2: Stage 2 Control & Delays
  # ========================================================================
  - type: grid
    title: Stage 2 Intelligent Control
    cards:
      - type: entities
        title: Stage 2 Delay Settings
        entities:
          - entity: number.smart_thermostat_stage_2_delay
            name: Current Delay Setting
          - entity: sensor.optimal_stage_2_delay
            name: Recommended Optimal Delay
          - entity: sensor.stage2_active_urgency_factor
            name: Active Urgency Multiplier
          - entity: binary_sensor.stage2_temporarily_disabled
            name: Stage 2 Disabled?

      - type: entities
        title: Stage 2 Triggers & Inhibits
        entities:
          - entity: binary_sensor.stage2_near_setpoint_inhibit
            name: Near-Setpoint Inhibit (1.5Â°F)
          - entity: binary_sensor.stage2_large_delta_trigger
            name: Large Delta Trigger (>3Â°F)
          - entity: binary_sensor.stage2_should_engage
            name: âœ… Should Engage (Master)
          - entity: sensor.time_since_setpoint_change
            name: Time Since Setpoint Changed
          - entity: sensor.time_since_preset_change
            name: Time Since Preset Changed

      - type: button
        entity: button.disable_stage2_temporarily
        name: Disable Stage 2 Temporarily
        icon: mdi:numeric-2-box-outline
        tap_action:
          action: call-service
          service: button.press
          target:
            entity_id: button.disable_stage2_temporarily

  # ========================================================================
  # SECTION 3: Preset Urgency Factors
  # ========================================================================
  - type: grid
    title: Preset Urgency Factors
    cards:
      - type: entities
        title: Urgency Multipliers (<1.0 = faster, >1.0 = slower)
        entities:
          - entity: input_number.stage2_urgency_home
            name: ğŸ  Home (1.0 = neutral)
          - entity: input_number.stage2_urgency_away
            name: ğŸš— Away (1.5 = efficiency)
          - entity: input_number.stage2_urgency_sleep
            name: ğŸ˜´ Sleep (1.2 = quieter)
          - entity: input_number.stage2_urgency_boost
            name: ğŸ”¥ Boost (0.5 = fastest)

      - type: markdown
        content: |
          ## How Urgency Works

          The **urgency factor** multiplies the optimal delay:

          - **1.0x** = Use calculated optimal delay as-is
          - **0.5x** = Cut delay in half (faster stage 2)
          - **1.5x** = Increase delay by 50% (slower, more efficient)

          **Example:**
          - Optimal delay calculated: 10 minutes
          - Boost (0.5x): 5 minutes
          - Home (1.0x): 10 minutes
          - Away (1.5x): 15 minutes

  # ========================================================================
  # SECTION 4: Thermal Model Learning Progress
  # ========================================================================
  - type: grid
    title: Thermal Model Learning
    cards:
      - type: entities
        title: Learned Parameters (Active Preset)
        entities:
          - entity: sensor.active_preset_mode
            name: Active Preset
          - entity: input_number.thermostat_stage1_heating_rate_home
            name: Stage 1 Heating Rate (Â°C/hr)
          - entity: input_number.thermostat_stage2_additional_rate_home
            name: Stage 2 Additional Rate (Â°C/hr)
          - entity: input_number.thermostat_heat_loss_coefficient_home
            name: Heat Loss Coefficient
          - entity: input_number.thermostat_model_confidence_home
            name: Model Confidence (%)
          - entity: counter.thermostat_cycles_analyzed
            name: Cycles Analyzed

      - type: gauge
        entity: input_number.thermostat_model_confidence_home
        name: Learning Confidence
        min: 0
        max: 100
        needle: true
        severity:
          red: 0
          yellow: 50
          green: 80

      - type: history-graph
        title: Learning Progress Over Time
        hours_to_show: 168
        entities:
          - entity: input_number.thermostat_stage1_heating_rate_home
            name: Stage 1 Rate
          - entity: input_number.thermostat_stage2_additional_rate_home
            name: Stage 2 Add Rate
          - entity: input_number.thermostat_model_confidence_home
            name: Confidence

  # ========================================================================
  # SECTION 5: All Presets Learning Summary
  # ========================================================================
  - type: grid
    title: All Presets Learning Status
    cards:
      - type: entities
        title: Home Preset
        entities:
          - entity: input_number.thermostat_stage1_heating_rate_home
          - entity: input_number.thermostat_stage2_additional_rate_home
          - entity: input_number.thermostat_heat_loss_coefficient_home
          - entity: input_number.thermostat_model_confidence_home

      - type: entities
        title: Away Preset
        entities:
          - entity: input_number.thermostat_stage1_heating_rate_away
          - entity: input_number.thermostat_stage2_additional_rate_away
          - entity: input_number.thermostat_heat_loss_coefficient_away
          - entity: input_number.thermostat_model_confidence_away

      - type: entities
        title: Sleep Preset
        entities:
          - entity: input_number.thermostat_stage1_heating_rate_sleep
          - entity: input_number.thermostat_stage2_additional_rate_sleep
          - entity: input_number.thermostat_heat_loss_coefficient_sleep
          - entity: input_number.thermostat_model_confidence_sleep

      - type: entities
        title: Boost Preset
        entities:
          - entity: input_number.thermostat_stage1_heating_rate_boost
          - entity: input_number.thermostat_stage2_additional_rate_boost
          - entity: input_number.thermostat_heat_loss_coefficient_boost
          - entity: input_number.thermostat_model_confidence_boost

  # ========================================================================
  # SECTION 6: Rate-of-Change Diagnostics (Phase 3)
  # ========================================================================
  - type: grid
    title: ğŸ“Š Rate-of-Change Diagnostics
    cards:
      - type: entities
        title: Temperature Change Rates
        entities:
          - entity: sensor.temperature_change_rate_5min
            name: Change Rate (5min window)
          - entity: sensor.temperature_change_rate_10min
            name: Change Rate (10min window)
          - entity: sensor.temperature_change_stats_during_heating
            name: Average Change Rate (1hr)
          - entity: binary_sensor.losing_ground_while_heating
            name: âš ï¸ Losing Ground Alert

      - type: history-graph
        title: Temperature Change Rate Trend
        hours_to_show: 6
        entities:
          - entity: sensor.temperature_change_rate_5min
            name: 5min Rate
          - entity: sensor.temperature_change_rate_10min
            name: 10min Rate (smoother)

      - type: markdown
        content: |
          ## What to Watch For

          **Typical Values:**
          - **Heating:** +0.05 to +0.25 Â°F/min (normal)
          - **Cooling:** -0.01 to -0.05 Â°F/min (normal)
          - **âš ï¸ Alert:** < -0.08 Â°F/min (door open, extreme cold)

          **"Losing Ground" triggers when:**
          - Heating ON for 5+ minutes
          - AND temp still dropping or flat

          Use this data to decide if Phase 3 ROC automation is needed!

  # ========================================================================
  # SECTION 7: Thermal Model Predictions
  # ========================================================================
  - type: grid
    title: Thermal Model Predictions
    cards:
      - type: entities
        title: Predicted Cycle Times
        entities:
          - entity: sensor.predicted_time_to_setpoint_stage_1
            name: Stage 1 Only (minutes)
          - entity: sensor.predicted_time_to_setpoint_stage_1_2
            name: Both Stages (minutes)
          - entity: input_number.thermostat_target_cycle_time
            name: Target Cycle Time (minutes)
          - entity: sensor.current_heat_loss_rate
            name: Current Heat Loss Rate (Â°C/hr)

      - type: markdown
        content: |
          ## How Predictions Work

          The thermal model uses learned parameters to predict:

          1. **Stage 1 Only Time:** How long to reach setpoint with just stage 1
          2. **Both Stages Time:** How long with stage 1 + stage 2
          3. **Optimal Delay:** Calculated to hit target cycle time

          If predicted stage 1 time â‰¤ target: Long delay (stage 2 not needed)
          If predicted both stages â‰¥ target: Short delay (need maximum help)
          Otherwise: Calculate exact delay to hit target

  # ========================================================================
  # SECTION 8: System Performance & Efficiency
  # ========================================================================
  - type: grid
    title: Performance & Efficiency
    cards:
      - type: entities
        title: Today's Stats
        entities:
          - entity: sensor.heating_runtime_today
            name: Total Heating Runtime
          - entity: sensor.smart_thermostat_heat_stage_1_runtime_today
            name: Stage 1 Runtime
          - entity: sensor.smart_thermostat_heat_stage_2_runtime_today
            name: Stage 2 Runtime
          - entity: counter.thermostat_heating_cycles_today
            name: Heating Cycles Today
          - entity: sensor.heating_efficiency_score
            name: Efficiency Score (%)

      - type: gauge
        entity: sensor.heating_efficiency_score
        name: Heating Efficiency
        min: 0
        max: 100
        needle: true
        severity:
          red: 0
          yellow: 60
          green: 80

      - type: markdown
        content: |
          ## Efficiency Scoring

          **Target:** Stage 1 should run 75% of the time

          - **85-100%:** Excellent! Stage 2 used sparingly
          - **70-85%:** Good - balanced usage
          - **50-70%:** Fair - stage 2 used frequently
          - **<50%:** Poor - investigate why stage 2 runs so much

          **Why stage 2 might run often:**
          - Very cold weather (near design temperature)
          - Small house with fast heat loss
          - Large temperature changes (away â†’ home)
          - Short stage 2 delays configured

  # ========================================================================
  # SECTION 9: Safety & Diagnostics
  # ========================================================================
  - type: grid
    title: Safety & Diagnostics
    cards:
      - type: entities
        title: Safety Bounds
        entities:
          - type: section
            label: "Stage 1 Rate Bounds: 0.4 - 8.0 Â°C/hr"
          - type: section
            label: "Stage 2 Add Bounds: 0.2 - 6.0 Â°C/hr"
          - type: section
            label: "Heat Loss Bounds: 0.1 - 2.5"
          - entity: input_datetime.thermostat_last_model_update
            name: Last Model Update

      - type: markdown
        content: |
          ## Safety Reset System

          The thermal model automatically resets if learned parameters
          become physically impossible:

          **Checks every 6 hours:**
          - Stage 1 rate: 0.4 - 8.0 Â°C/hr
          - Stage 2 additional: 0.2 - 6.0 Â°C/hr
          - Heat loss coefficient: 0.1 - 2.5

          **If out of bounds:**
          - Sends notification with actual values
          - Resets to defaults
          - Confidence drops to 20%
          - Learning restarts

          **Note:** Bounds are relaxed for small houses!
          825 sqft can heat at 5-7 Â°C/hr easily.
